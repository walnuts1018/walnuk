services:
  server:
    build:
      context: .
      dockerfile: Dockerfile.backend
    working_dir: /app
    ports:
      - "8080:8080"
    environment:
      SCYLLA_URL: scylladb:9042
      BASE_URL: http://localhost:8080
      PORT: 8080
      RUST_LOG: debug
      RUST_LOG_FORMAT: text
    depends_on:
      - scylladb-create-keyspace
    develop:
      watch:
        - action: rebuild
          path: .
  scylladb:
    image: scylladb/scylla:2025.4.3
    command: "--smp 1 --memory 256M"
    ports:
      - "9042:9042"
    volumes:
      - scylla_data:/var/lib/scylla

  scylladb-create-keyspace:
    image: scylladb/scylla:2025.4.3
    volumes:
      - ./scylla/initdb.sh:/scylla_scripts/initdb.sh
    entrypoint: ["bash", "/scylla_scripts/initdb.sh"]
    environment:
      ENDPOINT: scylladb
      USER_NAME: cassandra
      PASSWORD: cassandra
    depends_on:
      - scylladb

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend.local
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_ENDPOINT: http://server:8080
      API_ENDPOINT: http://server:8080
    depends_on:
      - server
    develop:
      watch:
        - action: rebuild
          path: package.json
        - action: sync
          path: ./app
          target: /app/app
        - action: sync
          path: ./components
          target: /app/components
        - action: sync
          path: ./lib
          target: /app/lib

volumes:
  scylla_data:
